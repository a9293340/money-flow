name: ğŸš€ Deploy to Production

on:
  push:
    branches: [main]
    # åªåœ¨é€™äº›è·¯å¾‘æœ‰è®Šæ›´æ™‚è§¸ç™¼
    paths:
      - 'frontend/**'
      - 'deploy/**'
      - '.github/workflows/**'

  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'
      - 'deploy/**'
      - '.github/workflows/**'

  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼
    inputs:
      force_deploy:
        description: 'å¼·åˆ¶åŸ·è¡Œå®Œæ•´éƒ¨ç½² (å¿½ç•¥è·¯å¾‘æª¢æŸ¥)'
        required: false
        default: false
        type: boolean

env:
  # Docker ç›¸é—œ
  DOCKER_IMAGE: ${{ vars.DOCKER_IMAGE }}

  # Google Cloud ç›¸é—œ
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  CLOUD_RUN_REGION: ${{ secrets.CLOUD_RUN_REGION }}
  CLOUD_RUN_SERVICE: ${{ secrets.CLOUD_RUN_SERVICE }}

  # Node.js ç‰ˆæœ¬
  NODE_VERSION: ${{ vars.NODE_VERSION }}

  # æ‡‰ç”¨ç¨‹å¼ URLï¼ˆæ”¯æ´è‡ªå®šç¾©åŸŸåï¼‰
  SERVICE_URL: ${{ vars.SERVICE_URL }}

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥ - åªè¦ workflow è§¸ç™¼å°±åŸ·è¡Œ
  quality-check:
    name: ğŸ“‹ Code Quality Check
    runs-on: ubuntu-latest
    # åªæ’é™¤ [skip ci] æ¨™è¨˜
    if: |
      github.event_name == 'workflow_dispatch' || 
      github.event_name == 'pull_request' ||
      !contains(github.event.head_commit.message, '[skip ci]')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: 'yarn.lock'

      - name: ğŸ”§ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ” TypeScript check
        run: yarn type-check

      - name: ğŸ§¹ ESLint check
        run: yarn lint

      - name: ğŸ§ª Run tests
        run: yarn test

  # Docker å»ºç½®å’Œæ¨é€ - æ’é™¤ src-tauri å’Œ tests ç›®éŒ„
  build-and-push:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: quality-check
    # åªæ’é™¤ç´” src-tauri æˆ–ç´” tests è®Šæ›´
    if: |
      (needs.quality-check.result == 'success') && (
        github.event.inputs.force_deploy == 'true' ||
        github.event_name == 'pull_request' ||
        (
          github.event_name == 'push' &&
          !contains(github.event.head_commit.message, '[skip deploy]')
        )
      )
    outputs:
      deploy-tag: ${{ steps.tag.outputs.deploy_tag }}
      image-tags: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ·ï¸ Generate deployment tag
        id: tag
        run: |
          # ç”Ÿæˆå”¯ä¸€éƒ¨ç½²æ¨™ç±¤: {branch}-{timestamp}-{commit}
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          TIMESTAMP=$(date +"%Y%m%d-%H%M")
          COMMIT_SHORT="${GITHUB_SHA:0:7}"

          DEPLOY_TAG="${BRANCH_NAME}-${TIMESTAMP}-${COMMIT_SHORT}"

          echo "deploy_tag=${DEPLOY_TAG}" >> $GITHUB_OUTPUT
          echo "ğŸ·ï¸ Generated deployment tag: ${DEPLOY_TAG}"

      - name: ğŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=raw,value=${{ steps.tag.outputs.deploy_tag }}
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ—ï¸ Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./frontend/docker/Dockerfile.monorepo
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: ğŸ“ Display build info
        run: |
          echo "ğŸ·ï¸ Built image tags:"
          echo "${{ steps.meta.outputs.tags }}"
          echo "ğŸ”‘ Image digest: ${{ steps.build.outputs.digest }}"

  # éƒ¨ç½²åˆ° Cloud Run
  deploy:
    name: ğŸš€ Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [quality-check, build-and-push]
    environment: production
    # åªåœ¨ build-and-push æˆåŠŸä¸”æ˜¯ main branch push æˆ–æ‰‹å‹•è§¸ç™¼æ™‚éƒ¨ç½²
    if: |
      (needs.build-and-push.result == 'success') && 
      (github.event_name == 'push' || github.event.inputs.force_deploy == 'true')

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: âš™ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸš€ Deploy to Cloud Run
        run: |
          DEPLOY_TAG="${{ needs.build-and-push.outputs.deploy-tag }}"
          FULL_IMAGE="${{ env.DOCKER_IMAGE }}:${DEPLOY_TAG}"

          echo "ğŸ“ Deploying with versioned image: ${FULL_IMAGE}"
          echo "ğŸ·ï¸ Deployment tag: ${DEPLOY_TAG}"

          # æ›´æ–° Cloud Run YAML ä¸­çš„é¡åƒæ¨™ç±¤
          sed -i "s|image: .*|image: ${FULL_IMAGE}|" deploy/cloud-run-service.yaml

          echo "ğŸ“ Updated Cloud Run service configuration:"
          grep -A2 -B2 "image:" deploy/cloud-run-service.yaml

          # éƒ¨ç½²åˆ° Cloud Run
          gcloud run services replace deploy/cloud-run-service.yaml \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }}

          echo "âœ… Deployment completed successfully"
          echo "ğŸ·ï¸ Deployed version: ${DEPLOY_TAG}"

      - name: ğŸ”“ Allow unauthenticated access
        run: |
          gcloud run services add-iam-policy-binding ${{ env.CLOUD_RUN_SERVICE }} \
            --member="allUsers" \
            --role="roles/run.invoker" \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }}

      - name: ğŸŒ Set service URL
        id: url
        run: |
          SERVICE_URL="${{ env.SERVICE_URL }}"
          echo "ğŸŒ Using configured service URL: $SERVICE_URL"

          # é©—è­‰ URL ä¸ç‚ºç©º
          if [ -z "$SERVICE_URL" ]; then
            echo "âŒ SERVICE_URL variable is not set!"
            echo "ğŸ”§ Please add SERVICE_URL to GitHub Variables"
            echo "   Example: https://your-service.asia-east1.run.app"
            exit 1
          fi

          # é©—è­‰ URL æ ¼å¼
          if [[ $SERVICE_URL =~ ^https://.*$ ]]; then
            echo "âœ… Valid HTTPS URL format"
          else
            echo "âš ï¸ URL should start with https://"
          fi

          # æ³¨æ„: SERVICE_URL ç¾åœ¨ç”±ç’°å¢ƒè®Šæ•¸ç®¡ç†

  # éƒ¨ç½²å¾Œé©—è­‰
  verify-deployment:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy

    steps:
      - name: ğŸ¥ Basic Health Check
        run: |
          echo "ğŸ” Testing basic application health..."
          SERVICE_URL="${{ env.SERVICE_URL }}"

          echo "ğŸ“ Service URL: $SERVICE_URL"
          echo "ğŸ¯ Testing URL: $SERVICE_URL/api/health"

          # ç­‰å¾…æ‡‰ç”¨ç¨‹å¼å¯å‹•
          echo "â³ Waiting for application to be ready..."
          sleep 45

          # å¤šæ¬¡å˜—è©¦å¥åº·æª¢æŸ¥
          for i in {1..3}; do
            echo "ğŸ” Health check attempt $i/3..."
            
            if curl -f -s "$SERVICE_URL/api/health" -o /dev/null; then
              echo "âœ… Basic health check passed"
              echo "ğŸ‰ Service is responding correctly"
              exit 0
            else
              echo "âš ï¸ Attempt $i failed"
              if [ $i -lt 3 ]; then
                echo "ğŸ’¤ Waiting 20 seconds before retry..."
                sleep 20
              fi
            fi
          done

          echo "âŒ Basic health check failed after 3 attempts"
          echo "ğŸ”§ Final attempt with verbose output:"
          curl -v "$SERVICE_URL/api/health" || echo "Connection failed"
          exit 1

      - name: âš™ï¸ Health Check - Environment
        run: |
          echo "ğŸ” Testing environment configuration..."
          SERVICE_URL="${{ env.SERVICE_URL }}"

          if curl -f -s "$SERVICE_URL/api/health/env" -o /dev/null; then
            echo "âœ… Environment health check passed"
          else
            echo "âš ï¸ Environment health check failed (non-critical)"
            echo "This may be due to missing environment variables"
          fi

      - name: ğŸ‰ Deployment Success
        run: |
          echo "ğŸŠ Deployment completed successfully!"
          echo "ğŸŒ Application URL: ${{ env.SERVICE_URL }}"
          echo "ğŸ¥ Health Check: ${{ env.SERVICE_URL }}/api/health"
          echo "ğŸ·ï¸ Deployed Version: ${{ needs.deploy.outputs.deploy-tag || 'N/A' }}"
          echo "ğŸ³ Docker Image: ${{ env.DOCKER_IMAGE }}:${{ needs.deploy.outputs.deploy-tag || 'latest' }}"
          echo "ğŸ“… Deployed at: $(date)"
          echo ""
          echo "ğŸš€ Personal Finance Manager is now live!"
          echo "You can access the application at the URL above."

  # éƒ¨ç½²é€šçŸ¥
  notify:
    name: ğŸ“¢ Smart Notification
    runs-on: ubuntu-latest
    needs: [quality-check, build-and-push, deploy, verify-deployment]
    if: always() && needs.quality-check.result != 'skipped'

    steps:
      - name: ğŸ“Š Pipeline Summary
        run: |
          echo "ğŸ“‹ Pipeline Summary Report"
          echo "========================="
          echo "ğŸ•’ åŸ·è¡Œæ™‚é–“: $(date)"
          echo "ğŸ¯ è§¸ç™¼æ–¹å¼: ${{ github.event_name }}"
          if [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "âš¡ æ‰‹å‹•å¼·åˆ¶éƒ¨ç½²: å·²å•Ÿç”¨"
          fi
          echo ""

          # åˆ†æåŸ·è¡Œçš„éšæ®µ
          QUALITY_STATUS="${{ needs.quality-check.result }}"
          BUILD_STATUS="${{ needs.build-and-push.result }}"
          DEPLOY_STATUS="${{ needs.deploy.result }}"
          VERIFY_STATUS="${{ needs.verify-deployment.result }}"

          echo "ğŸ“Š åŸ·è¡Œéšæ®µç‹€æ…‹:"
          echo "  ğŸ“‹ Code Quality: $QUALITY_STATUS"
          echo "  ğŸ³ Build & Push: $BUILD_STATUS"
          echo "  ğŸš€ Deploy: $DEPLOY_STATUS"
          echo "  âœ… Verify: $VERIFY_STATUS"
          echo ""

          echo "ğŸ’¡ æ™ºèƒ½è§¸ç™¼æç¤º:"
          echo "  - åªä¿®æ”¹æ–‡æª” (.md, docs/) â†’ å®Œå…¨è·³é"
          echo "  - ä¿®æ”¹ç¨‹å¼ç¢¼ä½†é Web ç›¸é—œ â†’ åªåŸ·è¡Œå“è³ªæª¢æŸ¥"  
          echo "  - ä¿®æ”¹ Web æª”æ¡ˆ (app/, server/, nuxt.configç­‰) â†’ åŸ·è¡Œå®Œæ•´éƒ¨ç½²"
          echo "  - ä¿®æ”¹ Tauri é…ç½® (src-tauri/) â†’ åªåŸ·è¡Œå“è³ªæª¢æŸ¥"
          echo "  - ä¿®æ”¹ deploy/ é…ç½® â†’ åŸ·è¡Œå®Œæ•´éƒ¨ç½²"
          echo "  - æ‰‹å‹•è§¸ç™¼ + force_deploy â†’ å¼·åˆ¶åŸ·è¡Œæ‰€æœ‰éšæ®µ"
          echo "  - PR â†’ å“è³ªæª¢æŸ¥ + å»ºç½®æ¸¬è©¦ (ä¸éƒ¨ç½²)"

      - name: ğŸ‰ Complete Deployment Success
        if: needs.verify-deployment.result == 'success'
        run: |
          echo "ğŸŠ å®Œæ•´éƒ¨ç½²æµç¨‹æˆåŠŸï¼"
          echo "âœ… Personal Finance Manager å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ"
          echo "ğŸŒ æœå‹™ URL: ${{ env.SERVICE_URL }}"
          if [ -n "${{ needs.build-and-push.outputs.deploy-tag }}" ]; then
            echo "ğŸ·ï¸ éƒ¨ç½²ç‰ˆæœ¬: ${{ needs.build-and-push.outputs.deploy-tag }}"
            echo "ğŸ³ Docker Image: ${{ env.DOCKER_IMAGE }}:${{ needs.build-and-push.outputs.deploy-tag }}"
          fi
          echo "ğŸ¯ å®Œæ•´æµç¨‹: å“è³ªæª¢æŸ¥ â†’ Dockerå»ºç½® â†’ Cloud Runéƒ¨ç½² â†’ å¥åº·é©—è­‰ âœ…"

      - name: âš¡ Quality Check Only Success
        if: |
          needs.quality-check.result == 'success' && 
          (needs.build-and-push.result == 'skipped' || needs.build-and-push.result == '')
        run: |
          echo "âœ… ä»£ç¢¼å“è³ªæª¢æŸ¥é€šé"
          echo "ğŸ“‹ æ­¤æ¬¡è®Šæ›´åªåŒ…å«éé—œéµæª”æ¡ˆï¼Œå·²è·³é Docker å»ºç½®å’Œéƒ¨ç½²"
          echo "ğŸ’¡ è§¸ç™¼å®Œæ•´éƒ¨ç½²éœ€è¦ä¿®æ”¹ frontend/ æˆ– deploy/ ç›®éŒ„ä¸­çš„æª”æ¡ˆ"

      - name: ğŸš§ Build Only Success (PR)
        if: |
          needs.build-and-push.result == 'success' && 
          (needs.deploy.result == 'skipped' || needs.deploy.result == '') &&
          github.event_name == 'pull_request'
        run: |
          echo "âœ… Pull Request - å»ºç½®æ¸¬è©¦æˆåŠŸ"
          echo "ğŸ³ Docker æ˜ åƒå»ºç½®å®Œæˆï¼Œä½†æœªéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ"
          echo "ğŸ”€ åˆä½µåˆ° main branch å¾Œæœƒè‡ªå‹•è§¸ç™¼ç”Ÿç”¢éƒ¨ç½²"

      - name: âŒ Pipeline Failure
        if: |
          needs.quality-check.result == 'failure' ||
          needs.build-and-push.result == 'failure' ||
          needs.deploy.result == 'failure' ||
          needs.verify-deployment.result == 'failure'
        run: |
          echo "âŒ Pipeline åŸ·è¡Œå¤±æ•—"
          echo "ğŸš¨ Personal Finance Manager CI/CD æµç¨‹ä¸­æ–·"
          echo "ğŸ“Š è«‹æª¢æŸ¥å¤±æ•—çš„éšæ®µä¸¦æŸ¥çœ‹è©³ç´°æ—¥èªŒ"
          echo ""
          if [ "${{ needs.quality-check.result }}" == "failure" ]; then
            echo "ğŸ’¥ å“è³ªæª¢æŸ¥å¤±æ•— - è«‹ä¿®å¾©ä»£ç¢¼å•é¡Œ"
          fi
          if [ "${{ needs.build-and-push.result }}" == "failure" ]; then
            echo "ğŸ’¥ Docker å»ºç½®å¤±æ•— - è«‹æª¢æŸ¥ Dockerfile å’Œå»ºç½®é…ç½®"
          fi
          if [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "ğŸ’¥ éƒ¨ç½²å¤±æ•— - è«‹æª¢æŸ¥ Cloud Run é…ç½®å’Œæ¬Šé™"
          fi
          if [ "${{ needs.verify-deployment.result }}" == "failure" ]; then
            echo "ğŸ’¥ éƒ¨ç½²é©—è­‰å¤±æ•— - æœå‹™å¯èƒ½æœªæ­£ç¢ºå•Ÿå‹•"
          fi
