name: ğŸš€ Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

env:
  # Docker ç›¸é—œ
  DOCKER_IMAGE: ${{ vars.DOCKER_IMAGE }}
  
  # Google Cloud ç›¸é—œ
  GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  CLOUD_RUN_REGION: ${{ secrets.CLOUD_RUN_REGION }}
  CLOUD_RUN_SERVICE: ${{ secrets.CLOUD_RUN_SERVICE }}
  
  # Node.js ç‰ˆæœ¬
  NODE_VERSION: ${{ vars.NODE_VERSION }}

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  quality-check:
    name: ğŸ“‹ Code Quality Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'
          cache-dependency-path: frontend/yarn.lock

      - name: ğŸ”§ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ” TypeScript check
        run: yarn type-check

      - name: ğŸ§¹ ESLint check
        run: yarn lint

      - name: ğŸ§ª Run tests
        run: yarn test

  # Docker å»ºç½®å’Œæ¨é€
  build-and-push:
    name: ğŸ³ Build & Push Docker Image
    runs-on: ubuntu-latest
    needs: quality-check
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_IMAGE }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸ—ï¸ Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/docker/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  # éƒ¨ç½²åˆ° Cloud Run
  deploy:
    name: ğŸš€ Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [quality-check, build-and-push]
    environment: production
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: âš™ï¸ Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: ğŸš€ Deploy to Cloud Run
        run: |
          gcloud run services replace deploy/cloud-run-service.yaml \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }}

      - name: ğŸ”“ Allow unauthenticated access
        run: |
          gcloud run services add-iam-policy-binding ${{ env.CLOUD_RUN_SERVICE }} \
            --member="allUsers" \
            --role="roles/run.invoker" \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }}

      - name: ğŸŒ Get service URL
        id: url
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ env.CLOUD_RUN_SERVICE }} \
            --region=${{ env.CLOUD_RUN_REGION }} \
            --project=${{ env.GCP_PROJECT_ID }} \
            --format='value(status.url)')
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_OUTPUT
          echo "ğŸŒ Service URL: $SERVICE_URL"

    outputs:
      service-url: ${{ steps.url.outputs.SERVICE_URL }}

  # éƒ¨ç½²å¾Œé©—è­‰
  verify-deployment:
    name: âœ… Verify Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: ğŸ¥ Health Check - Database
        run: |
          echo "ğŸ” Testing database health..."
          if curl -f -s "${{ needs.deploy.outputs.service-url }}/api/health/database" >/dev/null; then
            echo "âœ… Database health check passed"
          else
            echo "âŒ Database health check failed"
            exit 1
          fi

      - name: âš™ï¸ Health Check - Environment
        run: |
          echo "ğŸ” Testing environment health..."
          if curl -f -s "${{ needs.deploy.outputs.service-url }}/api/health/env" >/dev/null; then
            echo "âœ… Environment health check passed"
          else
            echo "âŒ Environment health check failed"
            exit 1
          fi

      - name: ğŸ‰ Deployment Success
        run: |
          echo "ğŸŠ Deployment completed successfully!"
          echo "ğŸŒ Application URL: ${{ needs.deploy.outputs.service-url }}"
          echo "ğŸ¥ Health Check: ${{ needs.deploy.outputs.service-url }}/api/health/database"

  # éƒ¨ç½²é€šçŸ¥
  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [deploy, verify-deployment]
    if: always()
    
    steps:
      - name: ğŸ“¢ Success Notification
        if: needs.verify-deployment.result == 'success'
        run: |
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸé€šçŸ¥"
          echo "âœ… Personal Finance Manager å·²æˆåŠŸéƒ¨ç½²åˆ°ç”Ÿç”¢ç’°å¢ƒ"
          echo "ğŸŒ æœå‹™ URL: ${{ needs.deploy.outputs.service-url }}"
          echo "ğŸ•’ éƒ¨ç½²æ™‚é–“: $(date)"
          
      - name: âš ï¸ Failure Notification
        if: needs.verify-deployment.result == 'failure' || needs.deploy.result == 'failure'
        run: |
          echo "âŒ éƒ¨ç½²å¤±æ•—é€šçŸ¥"
          echo "ğŸš¨ Personal Finance Manager ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²å¤±æ•—"
          echo "ğŸ“Š è«‹æª¢æŸ¥ GitHub Actions æ—¥èªŒ"
          echo "ğŸ•’ å¤±æ•—æ™‚é–“: $(date)"