name: ğŸ§ª Test & Validation

on:
  push:
    branches: [develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: # å…è¨±æ‰‹å‹•è§¸ç™¼

env:
  NODE_VERSION: 22.12.0

jobs:
  # ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: ğŸ“‹ Code Quality & Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: frontend/yarn.lock

      - name: ğŸ”§ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ” TypeScript check
        run: yarn type-check

      - name: ğŸ§¹ ESLint check
        run: yarn lint

      - name: ğŸ§ª Run unit tests
        run: yarn test

      - name: ğŸ—ï¸ Build check
        run: yarn build

      - name: ğŸ“Š Upload build artifacts (for debugging)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: frontend/.output/
          retention-days: 7

  # å®‰å…¨æ€§æƒæ
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'yarn'
          cache-dependency-path: frontend/yarn.lock

      - name: ğŸ”§ Install dependencies
        run: yarn install --frozen-lockfile

      - name: ğŸ” Run npm audit
        run: yarn audit --level moderate --json || true

      - name: ğŸ”’ Check for security vulnerabilities
        run: |
          echo "ğŸ” Checking for known security vulnerabilities..."
          if yarn audit --level high; then
            echo "âœ… No high-severity vulnerabilities found"
          else
            echo "âš ï¸ High-severity vulnerabilities detected"
            echo "Please run 'yarn audit --level high' locally to review"
          fi

  # Docker å»ºç½®æ¸¬è©¦
  docker-build-test:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    needs: code-quality
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Build Docker image (test only)
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/docker/Dockerfile
          push: false
          tags: test-image:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: âœ… Docker build success
        run: echo "ğŸ‰ Docker image built successfully for testing"

  # æ¸¬è©¦çµæœåŒ¯ç¸½
  test-summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, docker-build-test]
    if: always()
    
    steps:
      - name: ğŸ“Š Generate test summary
        run: |
          echo "## ğŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Code Quality Results
          if [ "${{ needs.code-quality.result }}" == "success" ]; then
            echo "âœ… **Code Quality**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Code Quality**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Security Scan Results
          if [ "${{ needs.security-scan.result }}" == "success" ]; then
            echo "âœ… **Security Scan**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Security Scan**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Docker Build Results
          if [ "${{ needs.docker-build-test.result }}" == "success" ]; then
            echo "âœ… **Docker Build**: Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Docker Build**: Failed" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall Status
          if [ "${{ needs.code-quality.result }}" == "success" ] && [ "${{ needs.security-scan.result }}" == "success" ] && [ "${{ needs.docker-build-test.result }}" == "success" ]; then
            echo "ğŸ‰ **Overall Status**: All tests passed! Ready for deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Overall Status**: Some tests failed. Please review and fix issues before deployment." >> $GITHUB_STEP_SUMMARY
          fi

  # PR è‡ªå‹•è©•è«– (åƒ…é™ PR)
  pr-comment:
    name: ğŸ’¬ PR Comment
    runs-on: ubuntu-latest
    needs: [code-quality, security-scan, docker-build-test]
    if: github.event_name == 'pull_request' && always()
    
    steps:
      - name: ğŸ’¬ Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const results = {
              codeQuality: '${{ needs.code-quality.result }}',
              securityScan: '${{ needs.security-scan.result }}',
              dockerBuild: '${{ needs.docker-build-test.result }}'
            };
            
            const getEmoji = (status) => status === 'success' ? 'âœ…' : 'âŒ';
            
            const comment = `
            ## ğŸ§ª è‡ªå‹•æ¸¬è©¦çµæœ
            
            ${getEmoji(results.codeQuality)} **ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥**: ${results.codeQuality}
            ${getEmoji(results.securityScan)} **å®‰å…¨æ€§æƒæ**: ${results.securityScan}  
            ${getEmoji(results.dockerBuild)} **Docker å»ºç½®æ¸¬è©¦**: ${results.dockerBuild}
            
            ${Object.values(results).every(r => r === 'success') 
              ? 'ğŸ‰ æ‰€æœ‰æ¸¬è©¦é€šéï¼æ­¤ PR å¯ä»¥å®‰å…¨åˆä½µã€‚' 
              : 'âš ï¸ éƒ¨åˆ†æ¸¬è©¦å¤±æ•—ï¼Œè«‹æª¢æŸ¥ä¸¦ä¿®æ­£å•é¡Œå¾Œå†åˆä½µã€‚'
            }
            
            ---
            ğŸ¤– ç”± GitHub Actions è‡ªå‹•ç”Ÿæˆ
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });