# 收入預測功能 - 重新設計方案

## 📋 專案背景

原有的期望清單/收入預測管理功能過於複雜，包含太多使用者不需要的選項和技術概念。基於使用者回饋，我們需要重新設計一個**簡單、直觀、實用**的收入預測功能。

### 原有功能問題
- ❌ 模板功能增加不必要複雜性
- ❌ 智能匹配/手動匹配選項造成困惑
- ❌ 期間生成概念對使用者不友善
- ❌ 過多配置選項造成決策疲勞
- ❌ 工作流程不直觀

---

## 🎯 新設計目標

### 核心設計原則
1. **簡單優先**：最少的設定，最大的效果
2. **自動化優先**：設定完成後自動運作
3. **直觀操作**：功能名稱和流程符合使用者心理模型
4. **即時反馈**：操作結果立即可見

### 使用者旅程
```
創建收入預測 → 系統自動追蹤 → 查看分析結果 → 手動調整（如需要）
```

---

## 🔧 功能規格

### 1. 創建收入預測（簡化版）

#### 必填欄位
- **收入名稱**：例如「薪資」、「業績獎金」
- **預期金額**：例如 50,000 元
- **收入分類**：從現有收入分類中選擇
- **收入頻率**：每週/每月/每季/每年
- **開始日期**：從何時開始追蹤

#### 可選欄位
- **結束日期**：不填表示持續追蹤
- **備註**：描述這個收入項目

#### 智能匹配設定（統一設定）
- **金額容差**：預設 10%（可調整 0-50%）
- **日期容差**：預設 3 天（可調整 0-30 天）
- **自動匹配**：預設開啟（可關閉）

### 2. 自動追蹤機制

#### 系統自動執行
1. **建立追蹤期間**：根據頻率自動產生時間區段
2. **智能匹配收入記錄**：自動尋找符合條件的記錄
3. **計算統計數據**：達成率、趨勢、健康度等
4. **異常提醒**：逾期、異常金額等

#### 匹配邏輯
```javascript
匹配條件 = {
  分類: 相同收入分類,
  金額: 預期金額 ± 容差百分比,
  日期: 期間日期 ± 容差天數
}
```

### 3. 檢視與分析頁面

#### 主要檢視區塊
1. **概覽儀表板**
   - 本月預期收入 vs 實際收入
   - 整體達成率
   - 近期異常項目

2. **收入項目列表**
   - 顯示所有收入預測項目
   - 狀態：正常/延遲/異常
   - 快速操作按鈕

3. **詳細分析**（點擊項目進入）
   - 歷史趨勢圖表
   - 按期間的達成情況
   - 健康度評分

#### 核心操作功能
1. **手動歸檔**：將特定記錄手動關聯到期間
2. **智能匹配更新**：重新執行自動匹配
3. **檢視分析**：查看統計和趨勢

---

## 🗂️ 資料庫設計

### IncomeForecasting 主表
```javascript
{
  _id: ObjectId,
  userId: ObjectId,
  name: String,                    // 收入名稱
  expectedAmount: Number,          // 預期金額
  currency: String,                // 幣別，預設 'TWD'
  incomeCategory: ObjectId,        // 收入分類 ID
  frequency: String,               // 'weekly', 'monthly', 'quarterly', 'yearly'
  startDate: Date,                 // 開始日期
  endDate: Date,                   // 結束日期（可選）
  description: String,             // 備註
  
  // 智能匹配設定
  matchingConfig: {
    amountTolerance: Number,       // 金額容差百分比，預設 10
    dateTolerance: Number,         // 日期容差天數，預設 3
    autoMatch: Boolean             // 是否自動匹配，預設 true
  },
  
  // 統計資料
  statistics: {
    totalPeriods: Number,          // 總期間數
    matchedPeriods: Number,        // 已匹配期間數
    totalExpected: Number,         // 總預期金額
    totalReceived: Number,         // 總實收金額
    achievementRate: Number,       // 達成率
    lastMatchedAt: Date           // 最後匹配時間
  },
  
  isActive: Boolean,               // 是否啟用
  isDeleted: Boolean,              // 軟刪除標記
  createdAt: Date,
  updatedAt: Date
}
```

### IncomePeriod 期間表
```javascript
{
  _id: ObjectId,
  forecastingId: ObjectId,         // 關聯的收入預測 ID
  userId: ObjectId,
  periodNumber: Number,            // 期間序號（第1期、第2期...）
  startDate: Date,                 // 期間開始日期
  endDate: Date,                   // 期間結束日期
  expectedAmount: Number,          // 該期間預期金額
  
  // 匹配資料
  matchedRecords: [{
    recordId: ObjectId,            // 匹配的記錄 ID
    matchedAmount: Number,         // 匹配金額
    confidence: Number,            // 匹配信心度 (0-1)
    matchedAt: Date,              // 匹配時間
    isManual: Boolean             // 是否手動匹配
  }],
  
  // 統計計算
  actualAmount: Number,            // 實際收到金額
  status: String,                  // 'pending', 'partial', 'completed', 'overdue'
  achievementRate: Number,         // 該期間達成率
  healthScore: Number,             // 健康度評分 (0-100)
  
  isDeleted: Boolean,
  createdAt: Date,
  updatedAt: Date
}
```

---

## 🖥️ 前端介面設計

### 頁面結構
```
/income-forecasting
├── /                            # 主頁面（概覽 + 列表）
├── /new                         # 新增收入預測
├── /[id]                        # 單一收入預測詳細頁面
└── /[id]/periods               # 期間管理頁面
```

### 主頁面佈局
```
┌─────────────────────────────────────────┐
│ 標題列 + 新增按鈕                         │
├─────────────────────────────────────────┤
│ 概覽卡片區                               │
│ ┌────────┐ ┌────────┐ ┌────────┐        │
│ │本月預期│ │實際收入│ │達成率  │        │
│ │ 85,000 │ │ 82,500 │ │ 97.1%  │        │
│ └────────┘ └────────┘ └────────┘        │
├─────────────────────────────────────────┤
│ 收入預測項目列表                         │
│ ┌─────────────────────────────────────┐ │
│ │ 💰 薪資    │ 50,000 │ 每月 │ ✅ 正常│ │
│ │ 📈 業績獎金│ 15,000 │ 每季 │ ⚠️ 延遲│ │
│ │ 🎁 年終獎金│ 100,000│ 每年 │ ⏳ 等待│ │
│ └─────────────────────────────────────┘ │
└─────────────────────────────────────────┘
```

### 詳細頁面功能區塊
1. **基本資訊展示**
2. **三個主要操作按鈕**
   - 🔗 手動歸檔
   - 🤖 智能匹配更新  
   - 📊 檢視分析
3. **期間列表**（可摺疊）
4. **趨勢圖表**

---

## 🔄 工作流程

### 創建流程
1. 使用者填寫基本資訊
2. 系統驗證並儲存
3. 自動產生第一個期間
4. 開始背景智能匹配

### 日常運作
1. **自動匹配**（每日執行）
   - 掃描新的收入記錄
   - 根據匹配規則自動關聯
   - 更新統計資料

2. **使用者介入**（按需求）
   - 檢視異常項目
   - 手動調整匹配
   - 更新預測參數

### 分析檢視
1. **即時統計**：達成率、趨勢、健康度
2. **歷史分析**：過去6個月/1年的表現
3. **預測建議**：基於歷史數據的建議

---

## 🚀 實作計劃

### Phase 1: 核心功能 (週期 1-2)
- [ ] 建立新的資料模型
- [ ] 創建基本 CRUD API
- [ ] 實作智能匹配邏輯
- [ ] 建立主頁面和新增頁面

### Phase 2: 進階功能 (週期 3)
- [ ] 詳細頁面和分析功能
- [ ] 手動歸檔操作
- [ ] 期間管理功能
- [ ] 統計圖表

### Phase 3: 優化與測試 (週期 4)
- [ ] 效能優化
- [ ] 使用者體驗優化
- [ ] 測試與除錯
- [ ] 文檔完善

---

## 💡 關鍵改進

### 相較於舊版本
1. **移除模板功能**：直接創建實際項目
2. **統一智能匹配**：所有項目都使用智能匹配，可調整參數
3. **簡化配置**：只保留必要設定
4. **直觀命名**：使用使用者理解的詞彙
5. **自動化優先**：最小化手動操作需求

### 使用者體驗提升
- 設定步驟從 8 步簡化為 4 步
- 技術概念用詞改為日常用語
- 一鍵操作取代多步驟配置
- 即時反饋取代延遲更新

---

## 📊 成功指標

### 使用率指標
- 新增收入預測的完成率 > 80%
- 用戶活躍使用天數 > 30天
- 功能使用頻率提升 3x

### 滿意度指標
- 使用者回饋評分 > 4/5
- 支援票數量減少 50%
- 功能易用性評分 > 80%

---

**建立日期**: 2025-08-22  
**版本**: 1.0.0  
**狀態**: 待審核
